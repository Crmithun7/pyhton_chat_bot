<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Learn python</title>
<style>
:root { --bg:#0b1020; --panel:#121935; --border:#25305c; --muted:#a7b6ff; --text:#eaf1ff; }
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
h1{margin:0;font-size:18px}.pill{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted)}
main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
.row{display:flex;align-items:center;gap:8px;margin:6px 0}.col{display:flex;flex-direction:column;gap:8px}
input,button,select{background:#0f1634;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
button{cursor:pointer} small{color:var(--muted)} hr{border:0;border-top:1px solid var(--border);margin:12px 0}
#results button{margin:4px 0}.chat{height:260px;overflow:auto;background:#0f1634;border:1px solid var(--border);border-radius:10px;padding:8px}
.msg{margin:6px 0;padding:6px 8px;background:#1b2552;border-radius:8px}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
video{width:100%;border-radius:10px;background:#000} footer{text-align:center;color:var(--muted);padding:8px}
@media (max-width: 900px){main{grid-template-columns:1fr}}
</style>
<!-- Socket.IO v4 client (compatible with Flask-SocketIO) -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body>
<header>
  <h1>⚡Learn python</h1>
  <span id="who" class="pill">AI</span>
</header>

<main>
  <section class="card">
    <div class="col">
      <h3>1) API Settings</h3>
      <div class="row">
        <input id="apiBase" value="" style="flex:1" placeholder="https://your-domain (defaults to same-origin)"/>
        <button id="saveApi">Save</button>
        <button id="testApi">Test</button>
      </div>
      <small>Defaults to this page’s origin (Flask static). If running frontend elsewhere, it guesses http://[this-host]:5000.</small>
      <hr/>
      <h3>2) Register / Login</h3>
      <div class="row"><input id="username" placeholder="username"/><input id="password" type="password" placeholder="password"/></div>
      <div class="row"><button id="btnRegister">Register</button><button id="btnLogin">Login</button><button id="btnLogout">Logout</button></div>
      <small>JWT is saved and sent to Socket.IO.</small>
      <hr/>
      <h3>3) Your ID</h3>
      <div class="row"><input id="myCode" readonly/><button id="btnRegen">Regenerate</button></div>
      <hr/>
      <h3>4) Search & Pair</h3>
      <div class="row"><input id="search" placeholder="friend code or username..." style="flex:1"/><button id="btnSearch">Search</button></div>
      <div id="results"></div>
    </div>
  </section>

  <section class="card">
    <div class="grid2">
      <div>
        <h3>Call Controls</h3>
        <div class="row"><button id="btnCall" disabled>Start Call</button><button id="btnHang">Hang Up</button><span class="pill" id="roomPill">room: -</span></div>
        <video id="me" autoplay playsinline muted></video>
        <video id="peer" autoplay playsinline></video>
      </div>
      <div>
        <h3>Chat</h3>
        <div class="chat" id="chat"></div>
        <div class="row"><input id="chatInput" placeholder="type message..." style="flex:1"/><button id="sendMsg">Send</button></div>
        <small>Latest 50 messages shown.</small>
      </div>
    </div>
  </section>
</main>

<footer><small>If camera/mic fail in dev, open via: <code>python -m http.server 5500</code> → http://127.0.0.1:5500</small></footer>

<script>
/* ---------- API base wiring: same-origin first, fallback to :5000, URL ?api= override ---------- */
function trimTrailingSlash(u){ return u.replace(/\/+$/,''); }
function defaultApiBase(){
  const qp = new URLSearchParams(location.search);
  const override = qp.get('api');
  if (override) return trimTrailingSlash(override);

  // Prefer same-origin when the Flask server serves this file (CLIENT_DIR static)
  if (location.origin && location.origin.startsWith('http')) {
    return trimTrailingSlash(location.origin);
  }
  // Fallback for file:// or dev static server on a different port
  let host = location.hostname || '127.0.0.1';
  if (host === 'localhost') host = '127.0.0.1';
  return `http://${host}:5000`;
}

let API_BASE = trimTrailingSlash(localStorage.getItem('API_BASE') || defaultApiBase());
const $ = (id)=>document.getElementById(id);
$('apiBase').value = API_BASE;

let token = localStorage.getItem('ACCESS') || null;
let me = null, socket = null, room = null, pc = null, localIn = null, localOut = null;

function setWho(){ $('who').textContent = me?.username ? `${me.username} · code ${me.code}` : 'not logged in'; }
function logChat(who, text){ const d=document.createElement('div'); d.className='msg'; d.textContent=who+': '+text; $('chat').appendChild(d); $('chat').scrollTop=$('chat').scrollHeight; }
function warn(t){ alert(typeof t==='string'?t:(t?.message||'Error')); console.warn(t); }

async function api(path, method='GET', body=null){
  const headers = {'Content-Type':'application/json'};
  if(token) headers['Authorization'] = 'Bearer '+token;
  const res = await fetch(API_BASE + path, {method, headers, body: body?JSON.stringify(body):undefined, credentials:'include'});
  if(!res.ok){
    if(res.status===401 || res.status===422){ throw new Error('not authorized'); }
    const msg = await res.text(); throw new Error(msg || (res.status+' '+res.statusText));
  }
  // health returns {"ok": true}, other endpoints return JSON bodies
  return res.json();
}

/* ---------- Settings ---------- */
$('saveApi').onclick = ()=>{
  API_BASE = trimTrailingSlash($('apiBase').value.trim());
  localStorage.setItem('API_BASE', API_BASE);
  alert('Saved API base: ' + API_BASE);
  if (socket) { socket.disconnect(); socket = null; }
  if (token) connectSocket();
};
$('testApi').onclick = async ()=>{
  try{ const j=await api('/health'); alert('Backend OK: '+JSON.stringify(j)); }
  catch(e){ alert('Cannot reach backend at '+API_BASE+'\n'+(e.message||e)); }
};

/* ---------- Auth ---------- */
async function afterAuth(j){
  token = j.access_token;
  localStorage.setItem('ACCESS', token);
  me = j.user || (await api('/auth/me'));
  $('myCode').value = me.code || '';
  setWho();
  connectSocket();
}
$('btnRegister').onclick = async ()=>{ try{ const j=await api('/auth/register','POST',{username:$('username').value,password:$('password').value}); await afterAuth(j); }catch(e){ warn(e); } };
$('btnLogin').onclick = async ()=>{ try{ const j=await api('/auth/login','POST',{username:$('username').value,password:$('password').value}); await afterAuth(j); }catch(e){ warn(e); } };
$('btnLogout').onclick = ()=>{
  token=null; localStorage.removeItem('ACCESS'); me=null; setWho();
  if(socket){ socket.disconnect(); socket=null; }
  $('roomPill').textContent='room: -'; $('chat').innerHTML=''; $('btnCall').disabled=true;
};

/* ---------- Regenerate ID ---------- */
$('btnRegen').onclick = async ()=>{ try{ const j=await api('/id','POST'); me.code=j.code; $('myCode').value=me.code; setWho(); }catch(e){ warn(e); } };

/* ---------- Search & Pair ---------- */
$('btnSearch').onclick = async ()=>{
  const q = $('search').value.trim(); if(!q) return;
  try{
    const j = await api('/search?q='+encodeURIComponent(q));
    const box = $('results'); box.innerHTML='';
    if(!j.results.length){ box.textContent = 'No results'; return; }
    j.results.forEach(u=>{
      const btn = document.createElement('button');
      btn.textContent = `Request to pair with ${u.username} (${u.code})`;
      btn.onclick = ()=> socket?.emit('pair_with_code', {peer_code:u.code});
      box.appendChild(btn); box.appendChild(document.createElement('br'));
    });
  }catch(e){ warn(e); }
};

/* ---------- Socket.IO (wired to Flask-SocketIO at same origin) ---------- */
function connectSocket(){
  if(!token) return warn('login first');
  if(socket){ socket.disconnect(); }

  // Use same origin/path as Flask (serves at /socket.io by default)
  socket = io(API_BASE, {
    path: '/socket.io',
    transports: ['polling'],      // polling works everywhere; upgrade if ALLOW_WS=1
    auth: { token }
  });

  socket.on('connect', ()=> console.log('socket connected'));
  socket.on('whoami', ()=> console.log('socket authed'));
  socket.on('pair_request_sent', ()=> alert('Pair request sent'));
  socket.on('pair_error', j=> warn(j?.error||'pair error'));

  socket.on('pair_request', (j)=>{
    const ok = confirm(`Accept pair request from ${j.from.username}?`);
    socket.emit('pair_response', {request_id: j.request_id, accept: ok});
  });
  socket.on('pair_declined', ()=> alert('Pair request declined'));
  socket.on('paired', async (j)=>{
    room = j.room; $('roomPill').textContent='room: '+room; $('btnCall').disabled=false;
    socket.emit('join_room', {room});
    try{
      const msgs = await api('/messages/'+room, 'GET');
      $('chat').innerHTML=''; msgs.reverse().forEach(m=>logChat(m.sender_name, m.text));
    }catch(_){}
  });
  socket.on('new_message', m=> logChat(m.sender_name, m.text));

  // WebRTC signaling
  socket.on('rtc-offer', async ({sdp})=>{
    await ensureMedia();
    if(!pc) await createPC();
    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    socket.emit('rtc-answer', {room, sdp: pc.localDescription});
  });
  socket.on('rtc-answer', async ({sdp})=>{ if(pc) await pc.setRemoteDescription(new RTCSessionDescription(sdp)); });
  socket.on('rtc-ice', async ({candidate})=>{ try{ if(pc && candidate) await pc.addIceCandidate(candidate); }catch(e){ console.warn(e); } });
}

/* ---------- Chat send ---------- */
$('sendMsg').onclick = ()=>{
  if(!room) return warn('pair first');
  const text = $('chatInput').value.trim(); if(!text) return;
  socket.emit('send_message', {room, text}); $('chatInput').value='';
};

/* ---------- WebRTC ---------- */
$('btnCall').onclick = async ()=>{ if(!room) return warn('pair first'); await startCall(); };
$('btnHang').onclick = async ()=>{ await endCall(); };

async function ensureMedia(){
  if(localIn) return;
  localIn = await navigator.mediaDevices.getUserMedia({audio:true, video:true});
  $('me').srcObject = localIn;
}
async function createPC(){
  pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.onicecandidate = e=>{ if(e.candidate) socket.emit('rtc-ice', {room, candidate:e.candidate}); };
  pc.ontrack = e=>{ $('peer').srcObject = e.streams[0]; };
  localOut = new MediaStream();
  localIn.getTracks().forEach(t=> localOut.addTrack(t));
  localOut.getTracks().forEach(t=> pc.addTrack(t, localOut));
}
async function startCall(){
  await ensureMedia();
  if(!pc) await createPC();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit('rtc-offer', {room, sdp: pc.localDescription});
}
async function endCall(){
  if(pc){ pc.getSenders().forEach(s=> s.track && s.track.stop()); pc.close(); pc=null; }
  if(localIn){ localIn.getTracks().forEach(t=>t.stop()); localIn=null; }
  $('me').srcObject=null; $('peer').srcObject=null;
}

/* ---------- Bootstrap ---------- */
(async function boot(){
  try{
    const meResp = await api('/auth/me', 'GET');
    if(meResp.logged_in){ me = meResp; $('myCode').value = me.code; setWho(); connectSocket(); }
    else { setWho(); }
  }catch{ setWho(); }
})();
</script>
</body>
</html>
